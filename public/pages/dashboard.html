<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Trackle</title>
    <link href="./css/output.css" rel="stylesheet" />
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"
      integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz"
      crossorigin="anonymous"
    ></script>
  </head>
  <body class="bg-background min-h-screen" hx-ext="json-enc">
    <div class="min-h-screen w-full bg-transparent fixed z-[-1]">
      <div
        style="
          position: absolute;
          inset: 0;
          z-index: 0;
          background-image:
            linear-gradient(
              to right,
              rgba(255, 255, 255, 0.02) 1px,
              transparent 1px
            ),
            linear-gradient(
              to bottom,
              rgba(255, 255, 255, 0.02) 1px,
              transparent 1px
            ),
            radial-gradient(
              circle 500px at 20% 20%,
              rgba(139, 92, 246, 0.05),
              transparent
            ),
            radial-gradient(
              circle 500px at 80% 80%,
              rgba(59, 130, 246, 0.05),
              transparent
            );
          background-size:
            48px 48px,
            48px 48px,
            100% 100%,
            100% 100%;
          pointer-events: none;
        "
      ></div>
    </div>
    <main class="relative z-10">
      <nav class="bg-transparent">
        <div class="container mx-auto px-6 lg:px-8 py-8">
          <div class="flex justify-between items-center">
            <a href="/" class="text-2xl sm:text-4xl font-bold text-heading"
              >Trackle</a
            >
            <div class="flex items-center gap-1.5 sm:gap-3 md:gap-6">
              <div class="flex items-center gap-1.5">
                <span class="text-white/80 font-medium max-[425px]:hidden"
                  >User:
                </span>
                <span
                  id="user-name"
                  class="max-sm:text-sm text-white font-bold"
                ></span>
              </div>
              <div class="w-fit">
                <button
                  id="logout-btn"
                  class="max-sm:text-sm relative flex items-center w-full overflow-hidden px-4 sm:px-6 py-1.5 sm:py-2.5 rounded-full text-white font-bold bg-transparent outline outline-white"
                >
                  Logout
                </button>
              </div>
            </div>
          </div>
        </div>
      </nav>
      <div class="container mx-auto px-6 lg:px-8 py-8">
        <div class="flex justify-between items-center mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white">My Subscriptions</h1>
            <p class="mt-1">Manage and track all your subscriptions</p>
          </div>
          <button
            onclick="openModal()"
            class="bg-secondary text-white px-6 py-3 rounded-full font-bold cursor-pointer"
          >
            + Add Subscription
          </button>
        </div>

        <!-- Filters Section -->
        <div
          class="bg-transparent rounded-xl p-6 border border-white/30 card-gradient mb-8"
        >
          <h3 class="text-lg font-semibold text-white mb-4">Filters</h3>

          <div class="flex flex-col gap-6">
            <!-- Status Filter -->
            <div>
              <label class="block text-sm font-medium text-white/70 mb-3"
                >Status</label
              >
              <div class="flex gap-3 flex-wrap">
                <button
                  id="filter-all"
                  onclick="filterByStatus('all')"
                  class="px-4 py-2 rounded-full text-sm font-bold bg-accent outline outline-accent text-white cursor-pointer"
                >
                  All
                </button>
                <button
                  id="filter-active"
                  onclick="filterByStatus('active')"
                  class="px-4 py-2 rounded-full text-sm font-bold bg-transparent outline outline-white text-white cursor-pointer"
                >
                  Active
                </button>
                <button
                  id="filter-cancelled"
                  onclick="filterByStatus('cancelled')"
                  class="px-4 py-2 rounded-full text-sm font-bold bg-transparent outline outline-white text-white cursor-pointer"
                >
                  Cancelled
                </button>
                <button
                  id="filter-expired"
                  onclick="filterByStatus('expired')"
                  class="px-4 py-2 rounded-full text-sm font-bold bg-transparent outline outline-white text-white cursor-pointer"
                >
                  Expired
                </button>
              </div>
            </div>

            <!-- Price Range Filter -->
            <div>
              <label class="block text-sm font-medium text-white/70 mb-3">
                Price Range: $<span id="price-min-display">0</span> - $<span
                  id="price-max-display"
                  >1000</span
                >
              </label>
              <div class="flex gap-4 items-center">
                <input
                  type="range"
                  id="price-range"
                  min="0"
                  max="1000"
                  value="1000"
                  step="5"
                  class="flex-1 h-2 bg-white/20 rounded-lg appearance-none cursor-pointer accent-accent"
                  oninput="updatePriceRange()"
                />
                <button
                  onclick="resetFilters()"
                  class="px-4 py-2 rounded-full text-sm font-bold bg-transparent outline outline-white text-white cursor-pointer whitespace-nowrap"
                >
                  Reset
                </button>
              </div>
            </div>
          </div>
        </div>

        <div id="stats-container" class="grid md:grid-cols-3 gap-6 mb-8">
          <div
            class="bg-transparent rounded-xl p-6 border border-white/30 card-gradient"
          >
            <p class="!text-white/90 text-sm font-medium">Loading...</p>
          </div>
        </div>
        <div
          id="subscriptions-container"
          class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
        >
          <p class="!text-white/90 col-span-full text-center py-12">
            Loading subscriptions...
          </p>
        </div>
      </div>
      <!-- Add/Edit Modal -->
      <div
        id="modal"
        class="bg-black/90 hidden fixed inset-0 bg-opacity-50 flex items-center justify-center p-4 z-50"
      >
        <div
          class="bg-black border border-white/30 rounded-xl shadow-2xl max-w-md w-full p-8 max-h-[90dvh] overflow-y-auto"
        >
          <h3
            id="modal-title"
            class="text-3xl font-bold text-gray-900 mb-2 text-center"
          >
            Add Subscription
          </h3>
          <form id="subscription-form" class="space-y-4">
            <input type="hidden" id="subscription-id" name="id" />
            <div>
              <label class="block text-sm font-medium text-white/50 mb-2">
                Name
              </label>
              <input
                type="text"
                id="sub-name"
                name="name"
                required
                class="w-full px-4 py-3 border border-white/20 rounded-lg focus:outline-none focus:border-secondary placeholder:text-white/50 text-white/80"
              />
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-white/50 mb-2"
                  >Price</label
                >
                <input
                  type="number"
                  id="sub-price"
                  name="price"
                  step="0.01"
                  required
                  class="w-full px-4 py-3 border border-white/20 rounded-lg focus:outline-none focus:border-secondary placeholder:text-white/50 text-white/80"
                />
              </div>
              <div>
                <label class="block text-sm font-medium text-white/50 mb-2"
                  >Currency</label
                >
                <div
                  class="w-full px-4 py-3 border border-white/20 rounded-lg text-white/80"
                >
                  <select
                    id="sub-currency"
                    name="currency"
                    class="w-full h-full focus:outline-none bg-black"
                  >
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                  </select>
                </div>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-white/50 mb-2"
                >Frequency</label
              >
              <div
                class="w-full px-4 py-3 border border-white/20 rounded-lg text-white/80"
              >
                <select
                  id="sub-frequency"
                  name="frequency"
                  class="w-full h-full focus:outline-none bg-black"
                >
                  <option value="">Frequency</option>
                  <option value="daily">Daily</option>
                  <option value="weekly">Weekly</option>
                  <option value="monthly">Monthly</option>
                  <option value="yearly">Yearly</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-white/50 mb-2"
                >Category</label
              >
              <div
                class="w-full px-4 py-3 border border-white/20 rounded-lg text-white/80"
              >
                <select
                  id="sub-category"
                  name="category"
                  required
                  class="w-full h-full focus:outline-none bg-black"
                >
                  <option value="">Select a category</option>
                  <option value="sports">Sports</option>
                  <option value="news">News</option>
                  <option value="entertainment">Entertainment</option>
                  <option value="lifestyle">Lifestyle</option>
                  <option value="technology">Technology</option>
                  <option value="finance">Finance</option>
                  <option value="politics">Politics</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-white/50 mb-2"
                >Payment Method</label
              >
              <input
                type="text"
                id="sub-payment"
                name="paymentMethod"
                required
                class="w-full px-4 py-3 border border-white/20 rounded-lg focus:outline-none focus:border-secondary placeholder:text-white/50 text-white/80"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-white/50 mb-2">
                Start Date
              </label>
              <div class="relative">
                <input
                  type="date"
                  id="sub-start-date"
                  name="startDate"
                  required
                  class="w-full px-4 py-3 border border-white/20 rounded-lg focus:outline-none focus:border-secondary placeholder:text-white/50 text-white/80 bg-transparent pr-12 appearance-none [&::-webkit-calendar-picker-indicator]:opacity-0 [&::-webkit-calendar-picker-indicator]:absolute [&::-webkit-calendar-picker-indicator]:right-4 [&::-webkit-calendar-picker-indicator]:cursor-pointer"
                />
                <!-- White Calendar Icon -->
                <span
                  class="pointer-events-none absolute inset-y-0 right-4 flex items-center"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    viewBox="0 0 24 24"
                    fill="white"
                    class="w-5 h-5 opacity-70"
                  >
                    <path
                      d="M7 10h5v5H7v-5zm12-7v2h-2V3H7v2H5V3H3v18h18V3h-2zm0 18H5V8h14v13z"
                    />
                  </svg>
                </span>
              </div>
            </div>
            <input type="hidden" name="status" value="active" />
            <div class="flex space-x-4 pt-4">
              <button
                type="submit"
                class="max-sm:text-sm relative flex items-center justify-center w-full overflow-hidden px-4 sm:px-6 py-1.5 sm:py-2.5 rounded-full text-white font-bold bg-accent outline outline-accent cursor-pointer"
              >
                Save
              </button>
              <button
                type="button"
                onclick="closeModal()"
                class="max-sm:text-sm relative flex items-center justify-center w-full overflow-hidden px-4 sm:px-6 py-1.5 sm:py-2.5 rounded-full text-white font-bold bg-transparent outline outline-white cursor-pointer"
              >
                Cancel
              </button>
            </div>
          </form>
        </div>
      </div>
    </main>
    <script>
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "{}");

      // Filter state
      let allSubscriptions = [];
      let currentStatusFilter = "all";
      let priceMin = 0;
      let priceMax = 1000;

      // Redirect if not logged in
      if (!token || !user._id) {
        window.location.href = "/login.html";
      }
      // Add auth header to all HTMX requests
      document.body.addEventListener("htmx:configRequest", (event) => {
        event.detail.headers["Authorization"] = `Bearer ${token}`;
      });

      // Load user's subscriptions
      function loadSubscriptions() {
        fetch(`/api/v1/subscriptions/user/${user._id}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success && data.data) {
              // Filter to only show current user's subscriptions
              allSubscriptions = data.data.filter(
                (sub) => sub.user._id === user._id || sub.user === user._id,
              );
              applyFilters();
            }
          })
          .catch((err) => console.error("Error loading subscriptions:", err));
      }

      // Filter functions
      function filterByStatus(status) {
        currentStatusFilter = status;

        // Update button styles
        document.querySelectorAll('[id^="filter-"]').forEach((btn) => {
          btn.classList.remove("bg-accent", "outline-accent");
          btn.classList.add("bg-transparent", "outline-white");
        });

        const activeBtn = document.getElementById(`filter-${status}`);
        activeBtn.classList.remove("bg-transparent", "outline-white");
        activeBtn.classList.add("bg-accent", "outline-accent");

        applyFilters();
      }

      function updatePriceRange() {
        priceMax = parseInt(document.getElementById("price-range").value);

        document.getElementById("price-min-display").textContent = 0;
        document.getElementById("price-max-display").textContent = priceMax;

        applyFilters();
      }

      function resetFilters() {
        currentStatusFilter = "all";
        priceMin = 0;
        priceMax = 1000;

        document.getElementById("price-range").value = 1000;
        document.getElementById("price-min-display").textContent = 0;
        document.getElementById("price-max-display").textContent = 1000;

        filterByStatus("all");
      }

      function applyFilters() {
        let filtered = allSubscriptions;

        // Filter by status
        if (currentStatusFilter !== "all") {
          filtered = filtered.filter(
            (sub) => sub.status === currentStatusFilter,
          );
        }

        // Filter by price range
        filtered = filtered.filter(
          (sub) => sub.price >= priceMin && sub.price <= priceMax,
        );

        renderStats(allSubscriptions); // Always show stats for all subscriptions
        renderSubscriptions(filtered);
      }

      function renderStats(subscriptions) {
        const active = subscriptions.filter((s) => s.status === "active");
        const monthlyTotal = active.reduce((sum, s) => {
          const amount = s.frequency === "yearly" ? s.price / 12 : s.price;
          return sum + amount;
        }, 0);
        document.getElementById("stats-container").innerHTML = `
          <div class="bg-transparent rounded-xl p-6 card-gradient border border-white/30">
             <p class="text-white/90 text-sm font-medium">Total Subscriptions</p>
             <p class="text-3xl font-bold !text-primary mt-2">${subscriptions.length}</p>
          </div>
          <div class="bg-transparent rounded-xl p-6 card-gradient border border-white/30">
             <p class="text-white/90 text-sm font-medium">Monthly Cost</p>
             <p class="text-3xl font-bold !text-primary mt-2">${monthlyTotal.toFixed(2)}</p>
          </div>
          <div class="bg-transparent rounded-xl p-6 card-gradient border border-white/30">
             <p class="text-white/90 text-sm font-medium">Active Subscriptions</p>
             <p class="text-3xl font-bold !text-primary mt-2">${active.length}</p>
          </div>
        `;
      }

      function renderSubscriptions(subscriptions) {
        const container = document.getElementById("subscriptions-container");
        if (subscriptions.length > 0) {
          container.innerHTML = subscriptions
            .map(
              (sub) => `
            <div class="bg-transparent rounded-xl p-6 border border-white/30 card-gradient">
              <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-semibold text-white/90">${sub.name}</h3>
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                  sub.status === "active"
                    ? "bg-primary text-secondary"
                    : "bg-red-100 text-red-800"
                }">
                  ${sub.status}
                </span>
              </div>
              <div class="space-y-2 mb-4">
                <div class="flex items-end gap-1">
                   <p class="!text-2xl font-bold text-white/70">${sub.price}</p>
                   <p class="!text-sm capitalize">/${sub.frequency}</p>
                </div>
                <p class="text-sm">Category: ${sub.category}</p>
                <p class="text-sm">Next Payment: ${sub.renewalDate ? new Date(sub.renewalDate).toLocaleDateString() : "Not set"}</p>
              </div>
              ${
                sub.status === "active"
                  ? `
              <div class="flex space-x-2">
                <button 
                  onclick="editSubscription('${sub._id}')" 
                  class="flex-1 bg-primary text-secondary py-2 rounded-full text-sm font-bold cursor-pointer"
                >
                  Edit
                </button>
                <button 
                  onclick="deleteSubscription('${sub._id}')"
                  class="flex-1 bg-red-100 text-red-700 py-2 rounded-full text-sm font-bold cursor-pointer"
                >
                  Delete
                </button>
              </div>
              `
                  : ""
              }
            </div>
          `,
            )
            .join("");
        } else {
          container.innerHTML =
            '<p class="col-span-full text-center py-12">No subscriptions yet. Add your first one!</p>';
        }
      }
      // Handle successful responses (kept for backward compatibility)
      document.body.addEventListener("htmx:afterSwap", (event) => {
        if (
          event.detail.target.id === "subscriptions-container" ||
          event.detail.target.id === "stats-container"
        ) {
          const response = event.detail.xhr.responseText;
          try {
            const data = JSON.parse(response);
            if (
              event.detail.target.id === "stats-container" &&
              data.success &&
              data.data
            ) {
              // Render stats
              const subscriptions = data.data;
              const active = subscriptions.filter((s) => s.status === "active");
              const monthlyTotal = subscriptions.reduce((sum, s) => {
                const amount =
                  s.frequency === "yearly" ? s.price / 12 : s.price;
                return sum + amount;
              }, 0);
              event.detail.target.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                  <p class="text-gray-600 text-sm font-medium">Total Subscriptions</p>
                  <p class="text-3xl font-bold text-gray-900 mt-2">${subscriptions.length}</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                  <p class="text-gray-600 text-sm font-medium">Monthly Cost</p>
                  <p class="text-3xl font-bold text-green-600 mt-2">$${monthlyTotal.toFixed(2)}</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                  <p class="text-gray-600 text-sm font-medium">Active Subscriptions</p>
                  <p class="text-3xl font-bold text-indigo-600 mt-2">${active.length}</p>
                </div>
              `;
            }
            if (
              event.detail.target.id === "subscriptions-container" &&
              data.success &&
              data.data
            ) {
              // Render subscriptions
              const subscriptions = data.data;
              if (subscriptions.length > 0) {
                event.detail.target.innerHTML = subscriptions
                  .map(
                    (sub) => `
                  <div class="bg-white rounded-lg shadow hover:shadow-lg transition p-6">
                    <div class="flex justify-between items-start mb-4">
                      <h3 class="text-xl font-semibold text-gray-900">${sub.name}</h3>
                      <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                        sub.status === "active"
                          ? "bg-green-100 text-green-800"
                          : "bg-red-100 text-red-800"
                      }">
                        ${sub.status}
                      </span>
                    </div>
                    <div class="space-y-2 mb-4">
                      <p class="text-2xl font-bold text-gray-900">$${sub.price}</p>
                      <p class="text-sm text-gray-600">${sub.frequency}</p>
                      <p class="text-sm text-gray-600">Category: ${sub.category}</p>
                      <p class="text-sm text-gray-600">Next: ${new Date(sub.renewalDate).toLocaleDateString()}</p>
                    </div>
                    <div class="flex space-x-2">
                      <button 
                        onclick="editSubscription('${sub._id}')" 
                        class="flex-1 bg-indigo-100 text-indigo-700 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-200 transition"
                      >
                        Edit
                      </button>
                      <button 
                        hx-put="/api/v1/subscriptions/${sub._id}/cancel"
                        hx-trigger="click"
                        hx-confirm="Are you sure you want to cancel this subscription?"
                        hx-on::after-request="document.body.dispatchEvent(new CustomEvent('subscriptionUpdated'))"
                        class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm font-semibold hover:bg-red-200 transition"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                `,
                  )
                  .join("");
              } else {
                event.detail.target.innerHTML =
                  '<p class="text-gray-500 col-span-full text-center py-12">No subscriptions yet. Add your first one!</p>';
              }
            }
          } catch (e) {
            console.error("Error parsing response:", e);
          }
        }
      });
      // Display user name
      document.getElementById("user-name").textContent = user.name || "User";
      // Logout
      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/";
      });
      // Modal functions
      function openModal() {
        document.getElementById("modal-title").textContent = "Add Subscription";
        document.getElementById("subscription-form").reset();
        document.getElementById("subscription-id").value = "";
        document.getElementById("modal").classList.remove("hidden");
      }
      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }
      // Form submission
      document
        .getElementById("subscription-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());
          const id = data.id;
          delete data.id;
          // Convert price to number
          data.price = parseFloat(data.price);
          try {
            const url = id
              ? `/api/v1/subscriptions/${id}`
              : "/api/v1/subscriptions";
            const method = id ? "PUT" : "POST";
            const response = await fetch(url, {
              method,
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });
            if (response.ok) {
              closeModal();
              // Trigger refresh
              loadSubscriptions();
            }
          } catch (error) {
            console.error("Error saving subscription:", error);
          }
        });
      // Edit subscription
      window.editSubscription = async (id) => {
        try {
          const response = await fetch(`/api/v1/subscriptions/${id}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const data = await response.json();
          if (data.success) {
            const sub = data.data;
            document.getElementById("modal-title").textContent =
              "Edit Subscription";
            document.getElementById("subscription-id").value = sub._id;
            document.getElementById("sub-name").value = sub.name;
            document.getElementById("sub-price").value = sub.price;
            document.getElementById("sub-currency").value = sub.currency;
            document.getElementById("sub-frequency").value = sub.frequency;
            document.getElementById("sub-category").value = sub.category;
            document.getElementById("sub-payment").value = sub.paymentMethod;
            document.getElementById("sub-start-date").value =
              sub.startDate.split("T")[0];
            document.getElementById("modal").classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading subscription:", error);
        }
      };

      // Delete subscription
      window.deleteSubscription = async (id) => {
        if (!confirm("Are you sure you want to cancel this subscription?"))
          return;

        try {
          const response = await fetch(`/api/v1/subscriptions/${id}/cancel`, {
            method: "PUT",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (response.ok) {
            loadSubscriptions();
          }
        } catch (error) {
          console.error("Error deleting subscription:", error);
        }
      };

      // Initial load
      loadSubscriptions();
    </script>
  </body>
</html>
