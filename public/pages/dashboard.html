<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - Trackle</title>
    <link href="./css/output.css" rel="stylesheet" />
    <script
      src="https://cdn.jsdelivr.net/npm/htmx.org@2.0.8/dist/htmx.min.js"
      integrity="sha384-/TgkGk7p307TH7EXJDuUlgG3Ce1UVolAOFopFekQkkXihi5u/6OCvVKyz1W+idaz"
      crossorigin="anonymous"
    ></script>
  </head>
  <body class="bg-gray-50 min-h-screen" hx-ext="json-enc">
    <!-- Navigation -->
    <nav class="bg-white shadow-sm">
      <div class="container mx-auto px-4 py-4">
        <div class="flex justify-between items-center">
          <a href="/dashboard.html" class="text-2xl font-bold text-indigo-600"
            >Trackle</a
          >
          <div class="flex items-center space-x-4">
            <span id="user-name" class="text-gray-700 font-medium"></span>
            <button
              id="logout-btn"
              class="text-gray-600 hover:text-red-600 font-medium"
            >
              Logout
            </button>
          </div>
        </div>
      </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
      <!-- Header -->
      <div class="flex justify-between items-center mb-8">
        <div>
          <h1 class="text-3xl font-bold text-gray-900">My Subscriptions</h1>
          <p class="text-gray-600 mt-1">
            Manage and track all your subscriptions
          </p>
        </div>
        <button
          onclick="openModal()"
          class="bg-indigo-600 text-white px-6 py-3 rounded-lg font-semibold hover:bg-indigo-700 transition shadow"
        >
          + Add Subscription
        </button>
      </div>

      <!-- Stats -->
      <div id="stats-container" class="grid md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-lg shadow p-6">
          <p class="text-gray-600 text-sm font-medium">Loading...</p>
        </div>
      </div>

      <!-- Subscriptions List -->
      <div
        id="subscriptions-container"
        class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"
      >
        <p class="text-gray-500 col-span-full text-center py-12">
          Loading subscriptions...
        </p>
      </div>
    </div>

    <!-- Add/Edit Modal -->
    <div
      id="modal"
      class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50"
    >
      <div class="bg-white rounded-xl shadow-2xl max-w-md w-full p-8">
        <h3 id="modal-title" class="text-2xl font-bold text-gray-900 mb-6">
          Add Subscription
        </h3>

        <form id="subscription-form" class="space-y-4">
          <input type="hidden" id="subscription-id" name="id" />

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Name</label
            >
            <input
              type="text"
              id="sub-name"
              name="name"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>

          <div class="grid grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Price</label
              >
              <input
                type="number"
                id="sub-price"
                name="price"
                step="0.01"
                required
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Currency</label
              >
              <select
                id="sub-currency"
                name="currency"
                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
              >
                <option value="USD">USD</option>
                <option value="EUR">EUR</option>
                <option value="GBP">GBP</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Frequency</label
            >
            <select
              id="sub-frequency"
              name="frequency"
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            >
              <option value="monthly">Monthly</option>
              <option value="yearly">Yearly</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Category</label
            >
            <input
              type="text"
              id="sub-category"
              name="category"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Payment Method</label
            >
            <input
              type="text"
              id="sub-payment"
              name="paymentMethod"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-2"
              >Start Date</label
            >
            <input
              type="date"
              id="sub-start-date"
              name="startDate"
              required
              class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            />
          </div>

          <input type="hidden" name="status" value="active" />

          <div class="flex space-x-4 pt-4">
            <button
              type="submit"
              class="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-semibold hover:bg-indigo-700 transition"
            >
              Save
            </button>
            <button
              type="button"
              onclick="closeModal()"
              class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
            >
              Cancel
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const token = localStorage.getItem("token");
      const user = JSON.parse(localStorage.getItem("user") || "{}");

      // Redirect if not logged in
      if (!token || !user._id) {
        window.location.href = "/login.html";
      }

      // Add auth header to all HTMX requests
      document.body.addEventListener("htmx:configRequest", (event) => {
        event.detail.headers["Authorization"] = `Bearer ${token}`;
      });

      // Load user's subscriptions
      function loadSubscriptions() {
        fetch(`/api/v1/subscriptions/user/${user._id}`, {
          headers: {
            Authorization: `Bearer ${token}`,
          },
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success && data.data) {
              renderStats(data.data);
              renderSubscriptions(data.data);
            }
          })
          .catch((err) => console.error("Error loading subscriptions:", err));
      }

      function renderStats(subscriptions) {
        const active = subscriptions.filter((s) => s.status === "active");
        const monthlyTotal = subscriptions.reduce((sum, s) => {
          const amount = s.frequency === "yearly" ? s.price / 12 : s.price;
          return sum + amount;
        }, 0);

        document.getElementById("stats-container").innerHTML = `
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-600 text-sm font-medium">Total Subscriptions</p>
            <p class="text-3xl font-bold text-gray-900 mt-2">${subscriptions.length}</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-600 text-sm font-medium">Monthly Cost</p>
            <p class="text-3xl font-bold text-green-600 mt-2">${monthlyTotal.toFixed(2)}</p>
          </div>
          <div class="bg-white rounded-lg shadow p-6">
            <p class="text-gray-600 text-sm font-medium">Active Subscriptions</p>
            <p class="text-3xl font-bold text-indigo-600 mt-2">${active.length}</p>
          </div>
        `;
      }

      function renderSubscriptions(subscriptions) {
        const container = document.getElementById("subscriptions-container");

        if (subscriptions.length > 0) {
          container.innerHTML = subscriptions
            .map(
              (sub) => `
            <div class="bg-white rounded-lg shadow hover:shadow-lg transition p-6">
              <div class="flex justify-between items-start mb-4">
                <h3 class="text-xl font-semibold text-gray-900">${sub.name}</h3>
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                  sub.status === "active"
                    ? "bg-green-100 text-green-800"
                    : "bg-red-100 text-red-800"
                }">
                  ${sub.status}
                </span>
              </div>
              <div class="space-y-2 mb-4">
                <p class="text-2xl font-bold text-gray-900">${sub.price}</p>
                <p class="text-sm text-gray-600 capitalize">${sub.frequency}</p>
                <p class="text-sm text-gray-600">Category: ${sub.category}</p>
                <p class="text-sm text-gray-600">Next: ${sub.renewalDate ? new Date(sub.renewalDate).toLocaleDateString() : "Not set"}</p>
              </div>
              <div class="flex space-x-2">
                <button 
                  onclick="editSubscription('${sub._id}')" 
                  class="flex-1 bg-indigo-100 text-indigo-700 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-200 transition"
                >
                  Edit
                </button>
                <button 
                  hx-put="/api/v1/subscriptions/${sub._id}/cancel"
                  hx-trigger="click"
                  hx-confirm="Are you sure you want to cancel this subscription?"
                  hx-on::after-request="loadSubscriptions()"
                  class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm font-semibold hover:bg-red-200 transition"
                >
                  Delete
                </button>
              </div>
            </div>
          `,
            )
            .join("");
        } else {
          container.innerHTML =
            '<p class="text-gray-500 col-span-full text-center py-12">No subscriptions yet. Add your first one!</p>';
        }
      }

      // Handle successful responses (kept for backward compatibility)
      document.body.addEventListener("htmx:afterSwap", (event) => {
        if (
          event.detail.target.id === "subscriptions-container" ||
          event.detail.target.id === "stats-container"
        ) {
          const response = event.detail.xhr.responseText;

          try {
            const data = JSON.parse(response);

            if (
              event.detail.target.id === "stats-container" &&
              data.success &&
              data.data
            ) {
              // Render stats
              const subscriptions = data.data;
              const active = subscriptions.filter((s) => s.status === "active");
              const monthlyTotal = subscriptions.reduce((sum, s) => {
                const amount =
                  s.frequency === "yearly" ? s.price / 12 : s.price;
                return sum + amount;
              }, 0);

              event.detail.target.innerHTML = `
                <div class="bg-white rounded-lg shadow p-6">
                  <p class="text-gray-600 text-sm font-medium">Total Subscriptions</p>
                  <p class="text-3xl font-bold text-gray-900 mt-2">${subscriptions.length}</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                  <p class="text-gray-600 text-sm font-medium">Monthly Cost</p>
                  <p class="text-3xl font-bold text-green-600 mt-2">$${monthlyTotal.toFixed(2)}</p>
                </div>
                <div class="bg-white rounded-lg shadow p-6">
                  <p class="text-gray-600 text-sm font-medium">Active Subscriptions</p>
                  <p class="text-3xl font-bold text-indigo-600 mt-2">${active.length}</p>
                </div>
              `;
            }

            if (
              event.detail.target.id === "subscriptions-container" &&
              data.success &&
              data.data
            ) {
              // Render subscriptions
              const subscriptions = data.data;

              if (subscriptions.length > 0) {
                event.detail.target.innerHTML = subscriptions
                  .map(
                    (sub) => `
                  <div class="bg-white rounded-lg shadow hover:shadow-lg transition p-6">
                    <div class="flex justify-between items-start mb-4">
                      <h3 class="text-xl font-semibold text-gray-900">${sub.name}</h3>
                      <span class="px-3 py-1 rounded-full text-xs font-semibold ${
                        sub.status === "active"
                          ? "bg-green-100 text-green-800"
                          : "bg-red-100 text-red-800"
                      }">
                        ${sub.status}
                      </span>
                    </div>
                    <div class="space-y-2 mb-4">
                      <p class="text-2xl font-bold text-gray-900">$${sub.price}</p>
                      <p class="text-sm text-gray-600">${sub.frequency}</p>
                      <p class="text-sm text-gray-600">Category: ${sub.category}</p>
                      <p class="text-sm text-gray-600">Next: ${new Date(sub.renewalDate).toLocaleDateString()}</p>
                    </div>
                    <div class="flex space-x-2">
                      <button 
                        onclick="editSubscription('${sub._id}')" 
                        class="flex-1 bg-indigo-100 text-indigo-700 py-2 rounded-lg text-sm font-semibold hover:bg-indigo-200 transition"
                      >
                        Edit
                      </button>
                      <button 
                        hx-put="/api/v1/subscriptions/${sub._id}/cancel"
                        hx-trigger="click"
                        hx-confirm="Are you sure you want to cancel this subscription?"
                        hx-on::after-request="document.body.dispatchEvent(new CustomEvent('subscriptionUpdated'))"
                        class="flex-1 bg-red-100 text-red-700 py-2 rounded-lg text-sm font-semibold hover:bg-red-200 transition"
                      >
                        Delete
                      </button>
                    </div>
                  </div>
                `,
                  )
                  .join("");
              } else {
                event.detail.target.innerHTML =
                  '<p class="text-gray-500 col-span-full text-center py-12">No subscriptions yet. Add your first one!</p>';
              }
            }
          } catch (e) {
            console.error("Error parsing response:", e);
          }
        }
      });

      // Display user name
      document.getElementById("user-name").textContent = user.name || "User";

      // Logout
      document.getElementById("logout-btn").addEventListener("click", () => {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "/";
      });

      // Modal functions
      function openModal() {
        document.getElementById("modal-title").textContent = "Add Subscription";
        document.getElementById("subscription-form").reset();
        document.getElementById("subscription-id").value = "";
        document.getElementById("modal").classList.remove("hidden");
      }

      function closeModal() {
        document.getElementById("modal").classList.add("hidden");
      }

      // Form submission
      document
        .getElementById("subscription-form")
        .addEventListener("submit", async (e) => {
          e.preventDefault();

          const formData = new FormData(e.target);
          const data = Object.fromEntries(formData.entries());
          const id = data.id;
          delete data.id;

          // Convert price to number
          data.price = parseFloat(data.price);

          try {
            const url = id
              ? `/api/v1/subscriptions/${id}`
              : "/api/v1/subscriptions";
            const method = id ? "PUT" : "POST";

            const response = await fetch(url, {
              method,
              headers: {
                Authorization: `Bearer ${token}`,
                "Content-Type": "application/json",
              },
              body: JSON.stringify(data),
            });

            if (response.ok) {
              closeModal();
              // Trigger refresh
              loadSubscriptions();
            }
          } catch (error) {
            console.error("Error saving subscription:", error);
          }
        });

      // Edit subscription
      window.editSubscription = async (id) => {
        try {
          const response = await fetch(`/api/v1/subscriptions/${id}`, {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          const data = await response.json();
          if (data.success) {
            const sub = data.data;
            document.getElementById("modal-title").textContent =
              "Edit Subscription";
            document.getElementById("subscription-id").value = sub._id;
            document.getElementById("sub-name").value = sub.name;
            document.getElementById("sub-price").value = sub.price;
            document.getElementById("sub-currency").value = sub.currency;
            document.getElementById("sub-frequency").value = sub.frequency;
            document.getElementById("sub-category").value = sub.category;
            document.getElementById("sub-payment").value = sub.paymentMethod;
            document.getElementById("sub-start-date").value =
              sub.startDate.split("T")[0];
            document.getElementById("modal").classList.remove("hidden");
          }
        } catch (error) {
          console.error("Error loading subscription:", error);
        }
      };

      // Initial load
      loadSubscriptions();
    </script>
  </body>
</html>
